#!/bin/bash -ex

DB_NAME=ninja
DB_USER=ninja
DB_PASS=$(mcookie)

ADMIN_USER="admin"
ADMIN_MAIL="noreply%40turnkeylinux.org" # '@' encoded = '%40'
ADMIN_PASS=turnkey1
ADMIN_FNAME="TurnKey" ADMIN_LNAME="Linux"

SRC=/usr/local/src
WEBROOT=/var/www/invoiceninja
CONF=$WEBROOT/.env

LOC_SHARE=/usr/local/share
LOC_BIN=/usr/local/bin

# install Invoice Ninja
mkdir -p $WEBROOT
unzip $SRC/invoiceninja.zip -d $WEBROOT
rm -f $SRC/invoiceninja.zip

chown -R www-data:www-data $WEBROOT

service mysql start

mysqladmin create $DB_NAME
mysql --batch --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

a2dissite 000-default
a2ensite invoiceninja
a2enmod rewrite

service apache2 start

cp $WEBROOT/.env.example $CONF
sed -i "\|API_SECRET=|s|=.*|=$(mcookie)$(mcookie)|" $CONF
sed -i 's/^APP_DEBUG=.*/APP_DEBUG=true/g' $CONF # REMOVE ME

sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/g" $CONF
sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/g" $CONF
sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/g" $CONF

#php $WEBROOT/artisan config:cache
php $WEBROOT/artisan key:generate --force
php $WEBROOT/artisan config:clear
php $WEBROOT/artisan migrate --force
php $WEBROOT/artisan optimize

chown -R www-data:www-data $WEBROOT
find $WEBROOT -type d -exec chmod 755 {} \;

sleep 10
CURL="curl -c /tmp/cookie -b /tmp/cookie"
TOKEN=$($CURL http://localhost/setup 2>/dev/null | grep csrf-token | sed 's|^.*content="\([a-zA-Z0-9]*\)".*$|\1|')
sleep 10
$CURL 'http://localhost/setup' -X POST --data-raw "\
_token=$TOKEN\
&url=https%3A%2F%2Fexample.com\
&https=on\
&db_driver=MySQL\
&db_host=localhost\
&db_port=3306\
&db_database=$DB_NAME\
&db_username=$DB_USER\
&db_password=$DB_PASS\
&mail_driver=log\
&mail_name=&mail_address=&mail_username=&mail_host=&mail_port=\
&encryption=tls\
&mail_password=\
&first_name=$ADMIN_FNAME\
&last_name=$ADMIN_LNAME\
&email=$ADMIN_MAIL\
&password=$ADMIN_PASS\
&terms_of_service=on\
&privacy_policy=on"

chown -R www-data:www-data $WEBROOT

echo '  * * * * * www-data php /var/www/invoiceninja/artisan schedule:run >> /dev/null 2>&1' >> /etc/cron.d/invoice-ninja

service mysql stop
service apache2 stop
